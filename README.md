# 手柄控制器项目

这是一个使用Xbox手柄控制macOS系统光标和执行系统操作的Rust项目。

## 项目结构

```
controller/
├── src/
│   ├── main.rs      # 应用层逻辑
│   ├── hid.rs       # HID底层接口
│   └── main_back.rs # 备份文件
├── Cargo.toml
├── Cargo.lock
└── README.md
```

## 架构设计

项目采用分层架构设计，将底层HID处理和应用层逻辑清晰分离：

### HID底层模块 (`hid.rs`)

负责所有与硬件设备交互的底层功能：

- **设备识别**: 定义Xbox手柄的VID/PID常量
- **按钮映射**: 定义各按钮的掩码值
- **数据解析**: 从HID报告中解析手柄状态
- **设备管理**: 设备连接、数据读取等

**主要组件**:
- `ControllerState`: 封装手柄所有输入状态的结构体
- `HidController`: HID设备管理器，提供高级接口
- 各种常量定义（VID、PID、按钮掩码、HID偏移量等）

### 应用层模块 (`main.rs`)

专注于业务逻辑和用户交互：

- **输入处理**: 将手柄输入转换为系统操作
- **光标控制**: 摇杆和陀螺仪控制鼠标移动
- **滚动和导航**: 右摇杆控制页面滚动和前进后退
- **按钮映射**: 将手柄按钮映射到鼠标点击和快捷键
- **AppleScript集成**: 调用系统功能（关闭窗口、调度中心等）

## 功能特性

### 输入控制
- **左摇杆**: 控制鼠标光标移动
- **右摇杆上下**: 页面滚动（平滑滚动）
- **右摇杆左右**: 浏览器前进/后退导航
- **LT + 陀螺仪**: 精确光标控制

### 按钮功能
- **A/B键**: 鼠标左右键
- **LB/RB键**: 切换标签页 (Cmd+Shift+[/])
- **X键**: 关闭当前窗口 (Cmd+W)
- **Y键**: 打开调度中心 (Mission Control)

## 技术特点

1. **清晰的分层架构**: 底层HID处理与应用逻辑完全分离
2. **高度可配置**: 敏感度、死区等参数可轻松调整
3. **平滑交互**: 使用节拍器线程实现平滑滚动
4. **错误处理**: 完善的错误处理和用户反馈
5. **可测试性**: HID模块包含单元测试

## 依赖项

- `hidapi`: HID设备通信
- `rdev`: 系统输入模拟
- `osakit`: AppleScript集成
- `display_info`: 屏幕信息获取
- `mouse_position`: 鼠标位置获取

## 使用方法

```bash
# 编译项目
cargo build --release

# 运行程序
cargo run

# 运行测试
cargo test
```

## 重构说明

此项目经过重构，将原本混合在`main.rs`中的HID底层代码完全分离到`hid.rs`模块中：

### 分离前的问题
- 底层HID解析逻辑与应用逻辑混合
- 代码可读性差，维护困难
- 难以进行单元测试
- 模块职责不清晰

### 分离后的优势
- **清晰的职责分离**: 底层专注硬件通信，应用层专注业务逻辑
- **提高可维护性**: 模块化设计便于独立开发和测试
- **增强可扩展性**: 可以轻松支持不同型号的手柄
- **改善可测试性**: 每个模块都可以独立测试

## 配置参数

可在`main.rs`中调整的主要参数：

```rust
const ANALOG_TRIGGER_THRESHOLD: u8 = 20;  // 模拟扳机阈值
const JOYSTICK_DEADZONE: i16 = 1000;      // 摇杆死区
const RIGHT_JOYSTICK_DEADZONE: i16 = 5000; // 右摇杆死区
const GYRO_DEADZONE: i16 = 10;            // 陀螺仪死区
const JOYSTICK_SENSITIVITY: f64 = 15.0;   // 摇杆灵敏度
const GYRO_SENSITIVITY: f64 = 0.08;       // 陀螺仪灵敏度
```
